# 错误处理逻辑重写计划

## 1. 问题分析

当前三个智能体的错误处理逻辑主要检查"404"错误，但根据用户提供的错误信息，当last_id失效时，火山方舟API返回的是**400错误**，具体错误码为：
- 错误码：`InvalidParameter.PreviousResponseNotFound`
- 错误信息：`Previous response with id ... not found`
- HTTP状态码：400

## 2. 修改目标

重写三个智能体的错误处理逻辑，使其能够：
- 正确识别last_id失效时返回的400错误
- 检查错误码`InvalidParameter.PreviousResponseNotFound`
- 检查错误信息中的"not found"关键字
- 当last_id失效时，调用init_assistant方法重新初始化对话

## 3. 修改步骤

### 3.1 修改director_assistant.py
- 更新Assistant.call方法中的错误处理逻辑
- 确保能识别400错误和"PreviousResponseNotFound"错误码
- 保持原有代码结构不变

### 3.2 修改outline_writer.py
- 更新OutlineWriter.call方法中的错误处理逻辑
- 确保能识别400错误和"PreviousResponseNotFound"错误码
- 保持原有代码结构不变

### 3.3 修改screenwriter.py
- 更新ScreenWriter.call方法中的错误处理逻辑
- 确保能识别400错误和"PreviousResponseNotFound"错误码
- 保持原有代码结构不变

## 4. 技术要点

- 使用更全面的错误检查条件：`"400" in error_msg or "404" in error_msg or "not found" in error_msg.lower()`
- 确保能捕获和处理`volcenginesdkarkruntime._exceptions.ArkBadRequestError`异常
- 保持代码的可读性和可维护性
- 确保三个智能体的错误处理逻辑保持一致

## 5. 测试策略

- 模拟last_id失效的情况，验证智能体是否能正确处理
- 确保正常情况下的调用不受影响
- 确保其他错误能被正确抛出

通过这些修改，智能体将能够更准确地识别last_id失效的情况，并自动重新初始化对话，提高系统的鲁棒性和用户体验。